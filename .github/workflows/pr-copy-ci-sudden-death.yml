name: pr-copy-ci-sudden-death

on:
  push:
    branches:
      - pr-copy-ci

jobs:
  # hato-botのCIの差分がpushされたらPRを作成する
  pr-copy-ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3.5.1
      - name: Set org name
        uses: actions/github-script@v6.4.1
        id: set_org_name
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          result-encoding: string
          script:
            return process.env.GITHUB_REPOSITORY.split('/')[0]
      - name: Get PullRequests
        uses: actions/github-script@v6.4.1
        id: get_pull_requests
        env:
          ORG_NAME: ${{steps.set_org_name.outputs.result}}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/pr_copy_ci_sudden_death/pr_copy_ci/get_pull_requests.js`)
            return await script({github, context})
      - name: Create PullRequest
        uses: actions/github-script@v6.4.1
        if: ${{ steps.get_pull_requests.outputs.result == 0 }}
        env:
          ORG_NAME: ${{steps.set_org_name.outputs.result}}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/scripts/pr_copy_ci_sudden_death/pr_copy_ci/create_pull_request.js`)
            await script({github, context})

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true
