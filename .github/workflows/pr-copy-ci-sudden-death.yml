name: pr-copy-ci-sudden-death
on:
  workflow_dispatch:
  push:
    branches:
      - master
jobs:
  # hato-botのCIの差分がpushされたらPRを作成する
  pr-copy-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Generate a token
        id: generate_token
        uses: actions/create-github-app-token@v1.7.0
        with:
          app-id: ${{ secrets.PROJECT_AUTOMATION_APP_ID }}
          private-key: ${{ secrets.PROJECT_AUTOMATION_PRIVATE_KEY }}
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          path: sudden-death
          ref: ${{ github.sha }}
          token: ${{steps.generate_token.outputs.token}}
      - name: Set org name
        uses: actions/github-script@v7.0.1
        id: set_org_name
        with:
          github-token: ${{steps.generate_token.outputs.token}}
          result-encoding: string
          script: return process.env.GITHUB_REPOSITORY.split('/')[0]
      - uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0
          repository: ${{steps.set_org_name.outputs.result}}/hato-bot
          path: hato-bot
      - name: Copy CI
        run: bash "${GITHUB_WORKSPACE}/sudden-death/scripts/pr_copy_ci_sudden_death/pr_copy_ci/copy_ci.sh"
      - name: Copy package.json
        uses: actions/github-script@v7.0.1
        with:
          github-token: ${{steps.generate_token.outputs.token}}
          script: |
            const script = require(`${process.env.GITHUB_WORKSPACE}/sudden-death/scripts/pr_copy_ci_sudden_death/pr_copy_ci/copy_package.js`)
            script()
      - uses: dev-hato/actions-diff-pr-management@v1.1.10
        with:
          github-token: ${{steps.generate_token.outputs.token}}
          branch-name-prefix: pr-copy-ci
          pr-title-prefix: hato-botのCIを反映するよ！
          working-directory: sudden-death
          exit-failure: 'false'
concurrency:
  group: ${{ github.workflow }}-${{ github.event_name }}-${{ github.ref }}
  cancel-in-progress: true
