name: pr-copy-ci-sudden-death

on:
  push:
    branches:
      - pr-copy-ci

jobs:
  # hato-botのCIの差分がpushされたらPRを作成する
  pr-copy-ci:
    runs-on: ubuntu-latest

    steps:
      - name: Set org name
        uses: actions/github-script@v6.3.3
        id: set_org_name
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          result-encoding: string
          script:
            return process.env.GITHUB_REPOSITORY.split('/')[0]
      - name: Get PullRequests
        uses: actions/github-script@v6.3.3
        id: get_pull_requests
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pulls_list_params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: "${{steps.set_org_name.outputs.result}}:pr-copy-ci",
              base: "master",
              state: "open"
            }
            console.log("call pulls.list:", pulls_list_params)
            const pulls = await github.paginate(github.rest.pulls.list, pulls_list_params)
            return pulls.filter(data => data.user.id === 41898282).length
      - name: Create PullRequest
        uses: actions/github-script@v6.3.3
        if: ${{ steps.get_pull_requests.outputs.result == 0 }}
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const pulls_create_params = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: "${{steps.set_org_name.outputs.result}}:pr-copy-ci",
              base: "master",
              title: "hato-botのCIを反映するよ！",
              body: "鳩の唐揚げおいしい！😋😋😋"
            }
            console.log("call pulls.create:", pulls_create_params)
            await github.rest.pulls.create(pulls_create_params)
