{"version":3,"file":"extract.js","sourceRoot":"","sources":["../../../../lib/modules/manager/github-actions/extract.ts"],"names":[],"mappings":"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","sourcesContent":["import { load } from 'js-yaml';\nimport { logger } from '../../../logger';\nimport { newlineRegex, regEx } from '../../../util/regex';\nimport { GithubTagsDatasource } from '../../datasource/github-tags';\nimport * as dockerVersioning from '../../versioning/docker';\nimport { getDep } from '../dockerfile/extract';\nimport type { PackageDependency, PackageFile } from '../types';\nimport type { Container, Workflow } from './types';\n\nconst dockerActionRe = regEx(/^\\s+uses: ['\"]?docker:\\/\\/([^'\"]+)\\s*$/);\nconst actionRe = regEx(\n  /^\\s+-?\\s+?uses: (?<replaceString>['\"]?(?<depName>[\\w-]+\\/[\\w-]+)(?<path>\\/.*)?@(?<currentValue>[^\\s'\"]+)['\"]?(?:\\s+#\\s+(?:renovate:\\s+)?tag=(?<tag>\\S+))?)/\n);\n\n// SHA1 or SHA256, see https://github.blog/2020-10-19-git-2-29-released/\nconst shaRe = regEx(/^[a-z0-9]{40}|[a-z0-9]{64}$/);\n\nfunction extractWithRegex(content: string): PackageDependency[] {\n  logger.trace('github-actions.extractWithRegex()');\n  const deps: PackageDependency[] = [];\n  for (const line of content.split(newlineRegex)) {\n    if (line.trim().startsWith('#')) {\n      continue;\n    }\n\n    const dockerMatch = dockerActionRe.exec(line);\n    if (dockerMatch) {\n      const [, currentFrom] = dockerMatch;\n      const dep = getDep(currentFrom);\n      dep.depType = 'docker';\n      deps.push(dep);\n      continue;\n    }\n\n    const tagMatch = actionRe.exec(line);\n    if (tagMatch?.groups) {\n      const {\n        depName,\n        currentValue,\n        path = '',\n        tag,\n        replaceString,\n      } = tagMatch.groups;\n      let quotes = '';\n      if (replaceString.indexOf(\"'\") >= 0) {\n        quotes = \"'\";\n      }\n      if (replaceString.indexOf('\"') >= 0) {\n        quotes = '\"';\n      }\n      const dep: PackageDependency = {\n        depName,\n        commitMessageTopic: '{{{depName}}} action',\n        datasource: GithubTagsDatasource.id,\n        versioning: dockerVersioning.id,\n        depType: 'action',\n        replaceString,\n        autoReplaceStringTemplate: `${quotes}{{depName}}${path}@{{#if newDigest}}{{newDigest}}${quotes}{{#if newValue}} # tag={{newValue}}{{/if}}{{/if}}{{#unless newDigest}}{{newValue}}${quotes}{{/unless}}`,\n      };\n      if (shaRe.test(currentValue)) {\n        dep.currentValue = tag;\n        dep.currentDigest = currentValue;\n      } else {\n        dep.currentValue = currentValue;\n        if (!dockerVersioning.api.isValid(currentValue)) {\n          dep.skipReason = 'invalid-version';\n        }\n      }\n      deps.push(dep);\n    }\n  }\n  return deps;\n}\n\nfunction extractContainer(container: string | Container): PackageDependency {\n  let dep: PackageDependency;\n  if (typeof container === 'string') {\n    dep = getDep(container);\n  } else {\n    dep = getDep(container?.image);\n  }\n  return dep;\n}\n\nfunction extractWithYAMLParser(\n  content: string,\n  filename: string\n): PackageDependency[] {\n  logger.trace('github-actions.extractWithYAMLParser()');\n  const deps: PackageDependency[] = [];\n\n  let pkg: Workflow;\n  try {\n    pkg = load(content, { json: true }) as Workflow;\n  } catch (err) {\n    logger.debug(\n      { filename, err },\n      'Failed to parse GitHub Actions Workflow YAML'\n    );\n    return [];\n  }\n\n  for (const job of Object.values(pkg.jobs ?? {})) {\n    if (job.container !== undefined) {\n      const dep = extractContainer(job.container);\n      dep.depType = 'container';\n      deps.push(dep);\n    }\n\n    for (const service of Object.values(job.services ?? {})) {\n      const dep = extractContainer(service);\n      dep.depType = 'service';\n      deps.push(dep);\n    }\n  }\n\n  return deps;\n}\n\nexport function extractPackageFile(\n  content: string,\n  filename: string\n): PackageFile | null {\n  logger.trace('github-actions.extractPackageFile()');\n  const deps = [\n    ...extractWithRegex(content),\n    ...extractWithYAMLParser(content, filename),\n  ];\n  if (!deps.length) {\n    return null;\n  }\n  return { deps };\n}\n"]}